<!-- Table of contents generated by http://tableofcontent.eu/ -->
- [Road Mapper Module](#road-mapper-module)
- [Description](#description)
- [Saving Remission Map Images](#saving-remission-map-images)
- [Splitting the Remission Map Images](#splitting-the-remission-map-images)
- [Rules for Ground Truth Annotations on Remission Map Images](#rules-for-ground-truth-annotations-on-remission-map-images)
- [Generating Road Maps from Annotated SVG Files](#generating-road-maps-from-annotated-svg-files)
- [Visualizing a Road Map](#visualizing-a-road-map)
	- [Examples](#examples)
- [Road Mapper Sampling](#road-mapper-sampling)
	- [Example of Generated Samples](#example-of-generated-samples)
- [Training the Neural Network](#training-the-neural-network)

# Road Mapper Module

## Description

The Road Mapper module handles the *map_type* CARMEN_ROAD_MAP_v (prefix character 'r'), the data structure *road_prob* and the map server message CARMEN_MAP_SERVER_ROAD_MAP_NAME. Each cell in a road gridmap contains the following data:
```c
typedef struct				/* Probabilities of a pixel in the road map */
{
  unsigned short off_road;		/* Probability of being off the road */
  unsigned short solid_marking;		/* Probability of being in a lane solid marking */
  unsigned short broken_marking;	/* Probability of being in a lane broken marking */
  unsigned short lane_center;		/* Probability of being at the center of a lane */
} road_prob;
```
The following color code is adopted for displaying a road map:
  - ![#ffffff](https://placehold.it/20x20/ffffff/?text=+) = off the road
  - ![#ff0000](https://placehold.it/20x20/ff0000/?text=+) = solid marking
  - ![#0000ff](https://placehold.it/20x20/0000ff/?text=+) = broken marking
  - ![#00ff00](https://placehold.it/20x20/00ff00/?text=+) = center of a lane

The Road Mapper module parameters can be found at [carmen-ford-escape.ini](../carmen-ford-escape.ini) and are the following:
```ini
 # Road Mapper

 road_mapper_sample_width		100	# pixels
 road_mapper_sample_height		100	# pixels
 road_mapper_distance_sample		5.0	# meters
 road_mapper_distance_offset		0.5	# meters
 road_mapper_n_offset			3	# n shifts to the left and n shifts to the right
 road_mapper_n_rotation			24	# delta = (360 degrees / n_rotation) degrees
 road_mapper_out_path			$CARMEN_HOME/data/road_mapper  		# out path for generated sample files
 road_mapper_out_path_remission		$CARMEN_HOME/data/road_mapper_remission # out path for generated sample files
 road_mapper_image_channels		1	# road map sample image pixel may have either 1 (B&W) or 3 channels (BGR)
 road_mapper_image_class_bits		4	# road map sample image pixel class may have 0 to 6 precision bits (B&W) or 1 to 8 precision bits (BGR)
 road_mapper_remission_image_channels	3	# remission map sample image pixel may have either 1 (B&W) or 3 channels (BGR) 
```

## Saving Remission Map Images

To save the remission map images please do the following:

First step:
Open a terminal tab on the carmen_lcad/bin directory and run:
```bash
 $ ./central
```
Second step:
Open another terminal tab on the carmen_lcad/bin directory and run the proccontrol program with the following .ini file [process-ida_a_guarapari_playback_road_mapper_save_remission_map_images.ini](../../bin/process-ida_a_guarapari_playback_road_mapper_save_remission_map_images.ini):
```bash
 $ ./proccontrol process-ida_a_guarapari_playback_road_mapper_save_remission_map_images.ini
```

## Splitting the Remission Map Images

To split the remission map images to ground truth annotation please do the following:

First step:
Open a terminal tab on this directory and create a list of the remission map images:
```bash
 $ ls ../../data/road_mapper_remission/*.png > remission_map_images.txt
```
Second step:
Run the [road_mapper_image_splitter.cpp](road_mapper_image_splitter.cpp) program:
```bash
 $ ./road_mapper_image_splitter 3 3 remission_map_images.txt ../../data/road_mapper_remission_350px/
```
To learn more about the parameters please look at [road_mapper_image_splitter.cpp](road_mapper_image_splitter.cpp)

## Rules for Ground Truth Annotations on Remission Map Images

1. Use [**Inkscape**](https://inkscape.org/en/download) to draw a polyline all the way along the center of each road lane.
2. Place both the start and finish points out of the image limits, in order to provide a better fit for each polyline.
3. Place the start point of each polyline in such a way that lane orientation matches the direction from the start point to the finish point.
4. If two polylines either cross, merge or fork, then make sure to draw the *"main"* polyline before the secondary. 
5. Make each point of the polyline auto-smooth, in order to generate a cubic Bezier curve.
6. Set each polyline stroke width properly, in order to fulfill each road lane and touch the borders of the neighbor lanes.
7. Select each line stroke paint color according to the following code:
  - ![#ff0000](https://placehold.it/20x20/ff0000/?text=+) RGB(255, 000, 000) = #ff0000 = single line marking on both lane sides.
  - ![#ff007f](https://placehold.it/20x20/ff007f/?text=+) RGB(255, 000, 127) = #ff007f = single line marking on the right side and broken line marking on the left side.
  - ![#7f00ff](https://placehold.it/20x20/7f00ff/?text=+) RGB(127, 000, 255) = #7f00ff = broken line marking on the right side and single line marking on the left side.
  - ![#0000ff](https://placehold.it/20x20/0000ff/?text=+) RGB(000, 000, 255) = #0000ff = broken line marking on both lane sides.
  - ![#00ff00](https://placehold.it/20x20/00ff00/?text=+) RGB(000, 255, 000) = #00ff00 = no line marking on both lane sides
  - ![#ff7f00](https://placehold.it/20x20/ff7f00/?text=+) RGB(255, 127, 000) = #ff7f00 = single line marking on the right side and no line marking on the left side.
  - ![#7fff00](https://placehold.it/20x20/7fff00/?text=+) RGB(127, 255, 000) = #7fff00 = no line marking on the right side and single line marking on the left side.
  - ![#007fff](https://placehold.it/20x20/007fff/?text=+) RGB(000, 127, 255) = #007fff = broken line marking on the right side and no line marking on the left side.
  - ![#00ff7f](https://placehold.it/20x20/00ff7f/?text=+) RGB(000, 255, 127) = #00ff7f = no line marking on the right side and broken line marking on the left side.
8. Save the Inkscape SVG file with same image name.

*R.Carneiro:	from i7726530_-353710.png to i7758030_-363790.png*

*R.Nascimento:	from i7705530_-338310.png to i7726460_-353990.png*

## Generating Road Maps from Annotated SVG Files

To generate the road maps from the svg files please do the following:

First step:
Create a list of svg fnames:
```bash
 $ ls svgs/*.svg > svg_list.txt
```
Second step:
Run the program road_mapper_generate_gt3.py program on this directory:
```bash
 $ python road_mapper_generate_gt3.py -f=svg_list.txt -n
```
To learn more about the parameters please look run the program with the -h option:
```bash
 $ python road_mapper_generate_gt3.py -h
```

## Visualizing a Road Map

To visualize a road map please do the following:

First step:
Run the central module as in [Saving Remission Map Images](#saving-remission-map-images)

Second step:
Run the [road_mapper_display_map3.cpp](road_mapper_display_map3.cpp) program on this directory passing the path to a .map file:
```bash
 $ ./road_mapper_display_map3 maps/r7725970_-353430.map 3 0
```
To learn more about the parameters please look at [road_mapper_display_map3.cpp](road_mapper_display_map3.cpp)


### Examples

<center>

| Image Name           | Remission Map                               | Ground Truth                                   | Road Map                                   |
| -------------------- | ------------------------------------------- | ---------------------------------------------- | ------------------------------------------ |
| i7705600_-338380.png | ![Remission Map](data/i7705600_-338380.png) | ![Ground Truth](data/i7705600_-338380_svg.png) | ![Road Map](data/r7705600_-338380_map.png) |
| i7726110_-353570.png | ![Remission Map](data/i7726110_-353570.png) | ![Ground Truth](data/i7726110_-353570_svg.png) | ![Road Map](data/r7726110_-353570_map.png) |

</center>

## Road Mapper Sampling

**Important: It is highly recommended to run the playback module with reduced (< 0.3) velocity!**

To sample the remission map images and road map images to train the neural network please do the following:

First step:
Run the central module as in [Saving Remission Map Images](#saving-remission-map-images)

Second step:
Open another terminal tab on the carmen_lcad/bin directory and run the proccontrol program with the following .ini file [process-ida_a_guarapari_playback_road_mapper_sampling.ini](../../bin/process-ida_a_guarapari_playback_road_mapper_sampling.ini):
```bash
 $ ./proccontrol process-ida_a_guarapari_playback_road_mapper_sampling.ini
```
### Example of Generated Samples

<center>

| Global Position    | Samples                                       |
| ------------------ | --------------------------------------------- |
| (7726093, -353507) | ![Sampling Gif](data/gif_7726093_-353507.gif) |
 
</center>

<!-- gif generated by  http://gifmaker.me/ -->

## Training the Neural Network

TODO.

**For more information look in docs/**


